trigger:
  branches:
    include:
      - main          # CD roda quando tem merge na main

pool:
  vmImage: 'default'

variables:
  buildConfiguration: 'Release'
  solution: '**/*.sln'
  publishDir: '$(Build.ArtifactStagingDirectory)/publish'
  webAppName: 'bs-tech'        # NOME do App Service
  serviceConnectionName: 'sc-azure-rg-prod'  # NOME da Service Connection

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: Build
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET 8 SDK'
            inputs:
              packageType: 'sdk'
              version: '8.x'

          - task: NuGetToolInstaller@1
            displayName: 'Install NuGet'

          - task: NuGetCommand@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              restoreSolution: '$(solution)'

          - task: DotNetCoreCLI@2
            displayName: 'Build'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration)'

          # Opcional: testes no CD tamb√©m
          # - task: DotNetCoreCLI@2
          #   displayName: 'Test'
          #   inputs:
          #     command: 'test'
          #     projects: '**/*Tests.csproj'
          #     arguments: '--configuration $(buildConfiguration)'
          #     publishTestResults: true

          - task: DotNetCoreCLI@2
            displayName: 'Publish'
            inputs:
              command: 'publish'
              publishWebProjects: true
              arguments: '--configuration $(buildConfiguration) --output $(publishDir)'
              zipAfterPublish: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifact'
            inputs:
              PathtoPublish: '$(publishDir)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Azure Web App'
    dependsOn: Build
    jobs:
      - job: DeployJob
        displayName: 'Deploy Job'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '$(serviceConnectionName)'
              appName: '$(webAppName)'
              package: '$(System.ArtifactsDirectory)/drop/**/*.zip'